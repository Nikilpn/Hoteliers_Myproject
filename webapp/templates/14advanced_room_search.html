{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Advanced Room Search - Hotel Booking</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
        }

        body {
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body>
    <div class="search-container">
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .search-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .search-header h1 {
        font-size: 2.5rem;
        color: #333;
        margin-bottom: 10px;
    }

    .search-header p {
        font-size: 1.1rem;
        color: #666;
    }

    .filter-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 0.95rem;
    }

    .filter-group input,
    .filter-group select {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.3s;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .price-range-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .date-range-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .search-button-group {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .search-button-group button {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-search {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-reset {
        background: #f0f0f0;
        color: #333;
    }

    .btn-reset:hover {
        background: #e0e0e0;
    }

    .results-info {
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        display: none;
    }

    .results-info.active {
        display: block;
    }

    .results-count {
        font-weight: 600;
        color: #333;
    }

    .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }

    .room-item {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        cursor: pointer;
    }

    .room-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .room-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f0f0f0;
    }

    .room-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #667eea;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .room-content {
        padding: 20px;
    }

    .room-type {
        display: inline-block;
        background: #f0f0f0;
        color: #667eea;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .room-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }

    .room-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .room-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
    }

    .room-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
    }

    .room-price-label {
        font-size: 0.85rem;
        color: #999;
        font-weight: 400;
    }

    .btn-book {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-book:hover {
        transform: scale(1.05);
    }

    .no-results {
        text-align: center;
        padding: 60px 20px;
    }

    .no-results-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .no-results-text {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 20px;
    }

    .loading {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .filter-chip {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .filter-chip .remove {
        cursor: pointer;
        margin-left: 6px;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }

        .search-header h1 {
            font-size: 1.8rem;
        }

        .rooms-grid {
            grid-template-columns: 1fr;
        }

        .search-button-group {
            flex-direction: column;
        }

        .search-button-group button {
            width: 100%;
        }
    }
    </style>

    <!-- Header -->
    <div class="search-header">
        <h1>üîç Find Your Perfect Room</h1>
        <p>Search and filter our rooms to find exactly what you need</p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form id="search-form">
            <div class="filter-grid">
                <!-- Room Name -->
                <div class="filter-group">
                    <label for="room-name">Room Name</label>
                    <input type="text" id="room-name" name="name" placeholder="e.g., Deluxe Room A">
                </div>

                <!-- Room Type -->
                <div class="filter-group">
                    <label for="room-type">Room Type</label>
                    <select id="room-type" name="room_type">
                        <option value="">All Room Types</option>
                        {% for room_type in room_types %}
                        <option value="{{ room_type.id }}">{{ room_type.ROOMTYPE|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Price Range -->
                <div class="filter-group">
                    <label>Price Range (‚Çπ)</label>
                    <div class="price-range-inputs">
                        <input type="number" id="min-price" name="min_price" placeholder="Min" min="0">
                        <input type="number" id="max-price" name="max_price" placeholder="Max" min="0">
                    </div>
                </div>

                <!-- Date Range -->
                <div class="filter-group">
                    <label>Dates</label>
                    <div class="date-range-inputs">
                        <input type="date" id="check-in" name="check_in">
                        <input type="date" id="check-out" name="check_out">
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="search-button-group">
                <button type="reset" class="btn-reset">Reset Filters</button>
                <button type="submit" class="btn-search">Search Rooms</button>
            </div>
        </form>
    </div>

    <!-- Active Filters Display -->
    <div id="active-filters" style="margin-bottom: 20px;"></div>

    <!-- Results Info -->
    <div class="results-info" id="results-info">
        <span class="results-count" id="results-count"></span>
    </div>

    <!-- Results -->
    <div id="results-container">
        <div class="no-results">
            <div class="no-results-icon">üè®</div>
            <div class="no-results-text">Use the filters above to search for rooms</div>
        </div>
    </div>
</div>

<script>
document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const params = new URLSearchParams();

    // Add form data to params
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }

    // Show loading
    showLoading();

    // Display active filters
    displayActiveFilters(formData);

    // Fetch results
    fetch(`/Backend/api/search/rooms/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRooms(data.rooms, data.count);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Error fetching rooms. Please try again.');
        });
});

function displayRooms(rooms, count) {
    const container = document.getElementById('results-container');
    const resultsInfo = document.getElementById('results-info');
    const resultsCount = document.getElementById('results-count');

    resultsCount.textContent = `Found ${count} room${count !== 1 ? 's' : ''}`;
    resultsInfo.classList.add('active');

    if (rooms.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">üòî</div>
                <div class="no-results-text">No rooms found matching your criteria</div>
                <p style="color: #999;">Try adjusting your filters</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="rooms-grid">
            ${rooms.map(room => `
                <div class="room-item">
                    <div style="position: relative;">
                        ${room.image ? `<img src="${room.image}" class="room-image" alt="${room.name}">` : '<div class="room-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>'}
                        <div class="room-badge">‚Çπ${room.price}/night</div>
                    </div>
                    <div class="room-content">
                        <div class="room-type">${escapeHtml(room.type)}</div>
                        <div class="room-name">${escapeHtml(room.name)}</div>
                        <div class="room-description">${escapeHtml(room.description || 'No description available')}</div>
                        <div class="room-footer">
                            <div>
                                <div class="room-price">‚Çπ${room.price}</div>
                                <div class="room-price-label">per night</div>
                            </div>
                            <a href="/booking_page/${room.id}/" class="btn-book">Book Now</a>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function showLoading() {
    document.getElementById('results-container').innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading rooms...</p>
        </div>
    `;
}

function showError(error) {
    document.getElementById('results-container').innerHTML = `
        <div class="no-results">
            <div class="no-results-icon">‚ö†Ô∏è</div>
            <div class="no-results-text">${escapeHtml(error)}</div>
        </div>
    `;
}

function displayActiveFilters(formData) {
    const filterChips = document.getElementById('active-filters');
    const filters = [];

    for (let [key, value] of formData.entries()) {
        if (value) {
            let displayName = value;
            if (key === 'name') displayName = `Name: ${value}`;
            else if (key === 'room_type') displayName = `Type: ${value}`;
            else if (key === 'min_price') displayName = `Min: ‚Çπ${value}`;
            else if (key === 'max_price') displayName = `Max: ‚Çπ${value}`;
            else if (key === 'check_in') displayName = `Check-in: ${value}`;
            else if (key === 'check_out') displayName = `Check-out: ${value}`;

            filters.push(`<span class="filter-chip">${escapeHtml(displayName)} <span class="remove" onclick="clearFilter('${key}')">‚úï</span></span>`);
        }
    }

    filterChips.innerHTML = filters.join('');
}

function clearFilter(filterName) {
    const form = document.getElementById('search-form');
    const input = form.querySelector(`[name="${filterName}"]`);
    if (input) {
        input.value = '';
        form.dispatchEvent(new Event('submit'));
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>
